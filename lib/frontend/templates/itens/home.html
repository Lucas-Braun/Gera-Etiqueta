<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Itens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-custom {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .navbar-brand {
            color: #17a2b8 !important;
            font-weight: 700;
        }

        .nav-link {
            color: #555 !important;
        }

        .nav-link:hover, .nav-link.active {
            color: #17a2b8 !important;
        }

        .content {
            padding: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section-title {
            color: #17a2b8;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #17a2b8;
        }

        .btn-primary {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #138496 0%, #17a2b8 100%);
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .table thead th {
            background: #17a2b8;
            color: white;
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background-color: #e3f2fd;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.4s ease-out;
            min-width: 300px;
            margin-bottom: 10px;
        }

        .toast.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .toast.error { background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .btn-acoes {
            padding: 4px 8px;
            font-size: 12px;
        }

        .campo-obrigatorio {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('itens.home') }}">
                <i class="bx bx-box"></i> Cadastro de Itens
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('home') }}">
                            <i class="bx bx-grid-alt"></i> Módulos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('recebimento.home') }}">
                            <i class="bx bx-package"></i> Recebimento
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <i class="bx bx-box"></i> Cadastro de Itens
            </div>
            <p class="mb-0">Gerenciamento de itens do estoque</p>
        </div>

        <div class="row">
            <!-- Formulário -->
            <div class="col-lg-4">
                <div class="form-card">
                    <h5 class="section-title" id="tituloFormulario">
                        <i class="bx bx-plus-circle"></i> Novo Item
                    </h5>

                    <form id="formItem">
                        <input type="hidden" id="itemIdEdicao" value="">

                        <div class="mb-3">
                            <label for="numeroItem" class="form-label">
                                Nº do Item <span class="campo-obrigatorio">*</span>
                            </label>
                            <input type="text" class="form-control" id="numeroItem" required>
                        </div>

                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricao">
                        </div>

                        <div class="mb-3">
                            <label for="unidadeMedida" class="form-label">Unidade de Medida</label>
                            <input type="text" class="form-control" id="unidadeMedida" placeholder="Ex: UN, KG, MT">
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bx bx-save"></i> <span id="textoSalvar">Salvar</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
                                <i class="bx bx-eraser"></i> Limpar
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="btnCancelar"
                                    onclick="cancelarEdicao()" style="display: none;">
                                <i class="bx bx-x"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabela -->
            <div class="col-lg-8">
                <div class="form-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title mb-0">
                            <i class="bx bx-list-ul"></i> Itens Cadastrados
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="consultarItens()">
                            <i class="bx bx-refresh"></i> Atualizar
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <input type="text" class="form-control form-control-sm" id="filtroNumero"
                                   placeholder="Filtrar Nº Item" onkeyup="aplicarFiltros()">
                        </div>
                        <div class="col-8">
                            <input type="text" class="form-control form-control-sm" id="filtroDescricao"
                                   placeholder="Filtrar Descrição" onkeyup="aplicarFiltros()">
                        </div>
                    </div>

                    <div class="alert alert-info py-2">
                        <strong>Mostrando:</strong> <span id="registrosMostrados">0</span> de <span id="totalRegistros">0</span> itens
                    </div>

                    <div class="table-container">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Nº Item</th>
                                    <th>Descrição</th>
                                    <th>Unidade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaItens">
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginação -->
                    <nav class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center mb-0" id="paginacao">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="text-center">
            <div class="spinner-border text-info mb-2"></div>
            <p>Processando...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let todosItens = [];
        let itensFiltrados = [];
        let paginaAtual = 1;
        const registrosPorPagina = 20;

        function mostrarLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function esconderLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function mostrarNotificacao(mensagem, tipo = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i class="bx ${tipo === 'success' ? 'bx-check-circle' : 'bx-x-circle'}"></i>
                <span>${mensagem}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function limparFormulario() {
            document.getElementById('formItem').reset();
            document.getElementById('itemIdEdicao').value = '';
            document.getElementById('tituloFormulario').innerHTML = '<i class="bx bx-plus-circle"></i> Novo Item';
            document.getElementById('textoSalvar').textContent = 'Salvar';
            document.getElementById('btnCancelar').style.display = 'none';
            document.getElementById('numeroItem').focus();
        }

        function aplicarFiltros() {
            const filtroNumero = document.getElementById('filtroNumero').value.toLowerCase();
            const filtroDescricao = document.getElementById('filtroDescricao').value.toLowerCase();

            itensFiltrados = todosItens.filter(item => {
                const matchNumero = !filtroNumero || (item.numero_item || '').toLowerCase().includes(filtroNumero);
                const matchDescricao = !filtroDescricao || (item.descricao || '').toLowerCase().includes(filtroDescricao);
                return matchNumero && matchDescricao;
            });

            paginaAtual = 1;
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabelaItens');
            tbody.innerHTML = '';

            document.getElementById('totalRegistros').textContent = todosItens.length;

            if (itensFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum item encontrado</td></tr>';
                document.getElementById('registrosMostrados').textContent = '0';
                document.getElementById('paginacao').innerHTML = '';
                return;
            }

            const inicio = (paginaAtual - 1) * registrosPorPagina;
            const fim = Math.min(inicio + registrosPorPagina, itensFiltrados.length);
            const itensPagina = itensFiltrados.slice(inicio, fim);

            document.getElementById('registrosMostrados').textContent = `${inicio + 1}-${fim}`;

            itensPagina.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.numero_item}</td>
                    <td title="${item.descricao}">${item.descricao.substring(0, 40)}${item.descricao.length > 40 ? '...' : ''}</td>
                    <td>${item.unidade_medida || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-acoes" onclick="editarItem(${item.id})" title="Editar">
                            <i class="bx bx-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-acoes" onclick="deletarItem(${item.id})" title="Excluir">
                            <i class="bx bx-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderizarPaginacao();
        }

        function renderizarPaginacao() {
            const totalPaginas = Math.ceil(itensFiltrados.length / registrosPorPagina);
            const paginacao = document.getElementById('paginacao');
            paginacao.innerHTML = '';

            if (totalPaginas <= 1) return;

            const liAnterior = document.createElement('li');
            liAnterior.className = 'page-item' + (paginaAtual === 1 ? ' disabled' : '');
            liAnterior.innerHTML = `<a class="page-link" href="#" onclick="irParaPagina(${paginaAtual - 1}); return false;">&laquo;</a>`;
            paginacao.appendChild(liAnterior);

            for (let i = 1; i <= totalPaginas; i++) {
                if (totalPaginas > 7) {
                    if (i === 1 || i === totalPaginas || (i >= paginaAtual - 1 && i <= paginaAtual + 1)) {
                        const li = document.createElement('li');
                        li.className = 'page-item' + (i === paginaAtual ? ' active' : '');
                        li.innerHTML = `<a class="page-link" href="#" onclick="irParaPagina(${i}); return false;">${i}</a>`;
                        paginacao.appendChild(li);
                    } else if (i === 2 || i === totalPaginas - 1) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = `<span class="page-link">...</span>`;
                        paginacao.appendChild(li);
                    }
                } else {
                    const li = document.createElement('li');
                    li.className = 'page-item' + (i === paginaAtual ? ' active' : '');
                    li.innerHTML = `<a class="page-link" href="#" onclick="irParaPagina(${i}); return false;">${i}</a>`;
                    paginacao.appendChild(li);
                }
            }

            const liProximo = document.createElement('li');
            liProximo.className = 'page-item' + (paginaAtual === totalPaginas ? ' disabled' : '');
            liProximo.innerHTML = `<a class="page-link" href="#" onclick="irParaPagina(${paginaAtual + 1}); return false;">&raquo;</a>`;
            paginacao.appendChild(liProximo);
        }

        function irParaPagina(pagina) {
            const totalPaginas = Math.ceil(itensFiltrados.length / registrosPorPagina);
            if (pagina < 1 || pagina > totalPaginas) return;
            paginaAtual = pagina;
            renderizarTabela();
        }

        function consultarItens() {
            mostrarLoading();

            fetch('/itens/api/itens')
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        mostrarNotificacao(result.error, 'error');
                        return;
                    }

                    todosItens = result.dados;
                    itensFiltrados = [...todosItens];
                    paginaAtual = 1;
                    renderizarTabela();
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao carregar itens: ' + error.message, 'error');
                })
                .finally(() => {
                    esconderLoading();
                });
        }

        document.getElementById('formItem').addEventListener('submit', function(e) {
            e.preventDefault();
            mostrarLoading();

            const itemIdEdicao = document.getElementById('itemIdEdicao').value;
            const dados = {
                numero_item: document.getElementById('numeroItem').value.trim(),
                descricao: document.getElementById('descricao').value.trim(),
                unidade_medida: document.getElementById('unidadeMedida').value.trim()
            };

            let url, method;
            if (itemIdEdicao) {
                url = `/itens/api/itens/${itemIdEdicao}`;
                method = 'PUT';
            } else {
                url = '/itens/api/itens';
                method = 'POST';
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    mostrarNotificacao(result.message, 'success');
                    limparFormulario();
                    consultarItens();
                } else {
                    mostrarNotificacao(result.error || 'Erro ao salvar', 'error');
                }
            })
            .catch(error => {
                mostrarNotificacao('Erro: ' + error.message, 'error');
            })
            .finally(() => {
                esconderLoading();
            });
        });

        function editarItem(itemId) {
            const item = todosItens.find(i => i.id === itemId);
            if (!item) {
                mostrarNotificacao('Item não encontrado', 'error');
                return;
            }

            document.getElementById('itemIdEdicao').value = item.id;
            document.getElementById('numeroItem').value = item.numero_item;
            document.getElementById('descricao').value = item.descricao || '';
            document.getElementById('unidadeMedida').value = item.unidade_medida || '';

            document.getElementById('tituloFormulario').innerHTML = '<i class="bx bx-edit"></i> Editar Item';
            document.getElementById('textoSalvar').textContent = 'Atualizar';
            document.getElementById('btnCancelar').style.display = 'inline-block';

            document.getElementById('numeroItem').focus();
            mostrarNotificacao('Item carregado para edição', 'success');
        }

        function deletarItem(itemId) {
            if (!confirm('Deseja realmente excluir este item?')) return;

            mostrarLoading();

            fetch(`/itens/api/itens/${itemId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        mostrarNotificacao(result.message, 'success');
                        consultarItens();
                    } else {
                        mostrarNotificacao(result.error, 'error');
                    }
                })
                .catch(error => {
                    mostrarNotificacao('Erro: ' + error.message, 'error');
                })
                .finally(() => {
                    esconderLoading();
                });
        }

        function cancelarEdicao() {
            limparFormulario();
            mostrarNotificacao('Edição cancelada', 'success');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            consultarItens();
            document.getElementById('numeroItem').focus();
        });
    </script>
</body>
</html>
